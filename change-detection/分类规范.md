# 分类规范

## 大小焊盘

- 对边，单边焊盘，面积占比超50%
- 邻边焊盘，面积占比，超80%
- 3条边及以上，小焊盘


## 缺陷构成

缺陷的位置（焊盘，防焊，孔，文字，基材，线路） + 缺陷位置描述（大的，小的，大的孔，小的孔） + 缺陷的形态 （划伤，杂质，及其他）


缺陷位置：
焊盘、防焊、孔

焊盘区域：
大焊盘、小焊盘、IC焊盘、BGA焊盘、带孔大焊盘、背钻孔大焊盘，大孔环焊盘、小孔环焊盘、数字焊盘、金手指、光学点焊盘；槽孔焊盘，小铜孔；

防焊区域：
基材绿油，铜面绿油，IC焊盘间绿油（掉绿油桥：IC焊盘间的防焊掉了），基材（无绿油），线路上绿油，白油文字；

孔内区域：
背钻孔，散热孔、基材孔、塞孔（V1~5）、槽孔


焊盘区域缺陷：
毛刺、粘胶、固定异物、移动异物、氧化、污染、缺损、刮伤、凸起凹陷、渗金、露镍、漏铜、漏镀，油性笔污染，曝偏、曝虚，铜渣，脱落，裂横。

防焊区域缺陷：
毛刺、杂质、移动异物、污染、刮伤、脱落、露铜、假漏、发白、沾金、错误（文字）、残缺、文字漏印，积墨、损伤，多钻、多铣、撞歪，撞断。

孔内区域：
沾金、假漏、钻偏、异物堵塞、树脂堵塞、铜渣堵塞、油墨堵塞，漏钻、漏铣、损伤、多钻、多铣。



## 防焊上焊盘，文字上焊盘，焊盘固定异物

防焊上焊盘：中间缺陷 + 边缘缺陷 （绿色）
文字上焊盘：中间缺陷 + 边缘缺陷 （灰白色）
焊盘固定异物：黑色及其他颜色 中间 边缘

PCB从工艺到算法梳理


2、焊盘凹起凸现

1、PCB板生产流程
2、缺陷分类标准，map图谱
    第一类：数据不足，包括大类数据不足，子类模式的数据不足
    第二类：类间相似，标签模棱两可
    第三类：数据充足，与其他类别间的差异明显，算法不足导致


横坐标：
缺陷的区域，主类别，子类别，

纵坐标：
缺陷的类型

经确认，关于PCB现场软件的耗时需要更正一下：
- 1s是AVI设置宽松 ，板面缺陷较少时（报点数10~20），复检软件的单板检测速度。
- 现场复检软件单点检测耗时50ms左右，现场AVI机台单板检测耗时3~5s。
- 所以当AVI单板报点超过60时，复检软件可能跟不上AVI。
- 如果假定单板报点数为500，则复检软件单点平均检测速度应在6~10ms。
- 客户目前期望的单点检测耗时是25ms。

3、软件流程
avi所给信息，gerber图，首件图，128*128的图像获取，大框滑动获取多个小框，一个框正确，最终结果正确；现场缺陷的分布不同于实验数据缺陷的分布；现场多数缺陷识别简单；
实验中的某一缺陷召回从50%提升到80%，如果该缺陷在现场不常见，则现场的缺陷召回提升不会很明显；如果是现场常见缺陷，则召回会提升明显；优先解决的缺陷要考虑几点：1、现场经常出现  2、重要缺陷，容忍度低  3、目前AI模型效果不好；数据收集ng-ng；完整pcb板学习缺陷位置；现场缺陷出现频率排序；


defect tracker：

散热孔堵塞异物，数孔，孔数多于某一值，NG


1、PCB数据梳理
    （1）缺陷区域，缺陷通用类型的梳理总结（已完成）
        - 缺陷区域分为：BGA焊盘，金手指，小焊盘，大焊盘，数字焊盘，线路，IC绿油，绿油，基材，文字，背钻孔，铜孔，塞孔，基材孔，散热孔。
        - 缺陷通用类型分为：漏铣，漏钻，多铣，多钻，漏塞，进树脂，沾油墨，铜渣，异物，漏镀，VCUT不良，脱落，残损，露铜，渗金，沾金，错位，曝虚，凸起凹陷，沾文字，发白，毛刺，污染，沾胶，假漏，漏镍，漏印，氧化，针孔压伤，移动异物，刮伤。

    （2）缺陷类型分类标准（部分完成）
        - 横坐标按缺陷区域层别从左至右重要性下降，同一区域的缺陷工艺标准一致，严重程度判定标准一致；纵坐标按通用缺陷名称从上至下重要性下降；用表格的形式建立缺陷图谱。
        - 缺陷类型 = 缺陷所处区域 + 通用缺陷名称。
        - 例：小焊盘异物 = 小焊盘 + 异物
        - 相同工艺标准的缺陷类型合并，不存在的缺陷类型去除，可能存在但缺少数据的缺陷类型留白。
     
    （3）数据集重新划分标签（部分为完成）
        - 按新标准重新划分数据集，改换新标签。

    （4）处理难以区分的，模棱两可的难数据标签（待完成）
        - 将数据集按7：3随机划分训练集，测试集训练新模型。
        - 根据AI测试结果，调整难数据标签的分类。调整原则，AI无严重错误，AI类型和标注类型工艺检出标准一致或接近时，修改标注为AI结果；如果工艺检出标准不一致，则标签往严格的方向靠；如果AI确实检测错误则跳过。
        - 重新按7:3划分数据集，训练新模型，迭代多次，直至需要修改的标签少于一定数量。

    （5）针对单个缺陷类型，对所有缺陷大类逐一梳理（待完成）
         目前划分的缺陷大类在75类左右，梳理单个缺陷大类可包含以下几个方面的内容：
            - 缺陷类型说明。（对应老版缺陷分类中的什么缺陷类型，划分依据和其他需要备注的信息）
            - 缺程度的判别标准。（大类中的子类缺陷程度判别标准应该保持一致）
            - 包含子类数，及每个子类中的数据量，记录数据不足的子类。（工作量可能较大）
            - 扩充不足的子类数据
    
    （6）梳理并扩充一定个数的大类缺陷后，需返回（4）迭代处理难标签的分类。

2、PCB数据收集
    （1）NG-NG数据的收集
        - 收集数据不足缺陷类型的NG-NG数据，其中类型混淆，或程度判错，但最终NG的数据价值更高。
    （2）OK-OK数据收集
        - 子类数据的扩充不仅要扩充NG数据，同时也应扩充与该子类模式相似的OK数据
    （3）OK-NG数据收集
    （4）NG-OK数据收集
        

3、PCB现场数据统计
    （1）现场缺陷占总数据的比率统计
    （2）AVI给出的缺陷类型准确度分析和统计
    （3）现场各缺陷出现的频率排序和分布统计

2、补充数据，处理难标签，算法优化。


1、深南电路进厂学习。 1d
2、整理缺陷类型分类标准。 2d

1、AOI和FQC车间。通过和现场人员的交流，学习PCB双面板的整体流程工艺。
2、将缺陷类型组成分为：区域 + 通用缺陷类型；以表格的形式排列组合，梳理所有可能出现的缺陷；将相同工艺标准的缺陷划分至同类

1、PCB生成工艺，软件，数据等小结。
2、根据新的标准重新划分数据集，刷新标签，和现场对齐处理难标签。
3、和现场对齐缺陷大类的细分，ng，ok数据收集，现场数据统计等工作。


1、算法人员在北京，工程人员在现场，现场给出的数据集及测试报告规范（命名、版本管理方案、指标等），希望达到的目的是：现场给出的数据和报告可以和北京的算法迭代无缝链接上，北京优化后的模型在现场可以直接测试效果提升
2、对现场的所有缺陷类别，需要进一步分析，确定哪些缺陷类型或者缺陷类型的子类需要用分割打补丁，哪些缺陷类型是回归分类和分割做的都不好的缺陷需讨论寻找解决方案



1、PCB生成工艺，算法流程，数据梳理等小结。  2.5d
2、探究AVI的可利用信息。  1d
3、刷新新标准下的数据集标签，和现场对齐难标签。 1d
4、按新类别计算指标，选择数据充足且漏检率高的类别进行错例分析。 1.5d

1、已完成。
2、AVI的缺陷类型信息（金属，局部，异色，严重，小面积）部分信息较精准，ROI信息有一定偏差。对于特定缺陷，如漏铜、渗金等的检出能力存疑。
3、已完成。
4、防焊区域，小焊盘区域的漏检较多，漏检多为程度判错导致。

1、PCB新方案梳理，工作细化。
2、现场对接，讨论新方案技术路线。

会议纪要
今天会议讨论了PCB算法新方案，主要内容如下：
1、AVI预计可进一步利用的信息
    - AVI的区域信息是较为可靠的。
    - AVI机台报点速度为2000点/min，算法效率达到20ms/点时可以一拖一，10ms/点时可以一拖二。
    - AVI的单张缺陷子图包含的信息：仅包含一个点的缺陷类别信息，包含最多两个点的层别（区域）信息，包含所有点的ROI信息。
    - AVI的ROI信息可能不准确，但发生的概率较低。

2、新方案要点
    - 强调复检，充分利用AVI的检出信息，去除传统算法。
    - 给予AVI检出类型更多的关注，AVI检出的高置信度缺陷可直通输出。
    - 用分类代替回归分类，用通用分割获取缺陷面积信息，辅以AVI的像素信息，区域信息等综合判断缺陷程度。

3、新方案可能存在的问题
    - AVI直通缺陷占比小，绝大部分缺陷还是得靠主算法解决。
    - 引入分割增加了标注成本，且标注困难。
    - 难以制定程度判别的规则，且判别规则的效果存疑。
    - 部分缺陷区域信息不可用，区域对判断缺陷程度的作用可能较小。
    - 部分缺陷无法通过面积来判断严重程度
    - 缺少补漏操作

4、改进和探索方向
    - 在现有缺陷类别较少的情况下，考虑用分类模块直接对缺陷的程度分类
    - 缩减某些缺陷的程度区分度，仅保留轻度和严重，去掉中度
    - 根据分类输出的缺陷置信度对结果进行筛选

1、新方案算法梳理讨论。  2d
2、分类，回归分类指标计算，标签转换等脚本工具。 1.5d
3、两组分类实验。 1d
4、箱子训练失败，得分错误问题查找。 0.5d

1、部分完成。和张辉，士清讨论了方案，暂定按照该方案往前推进，但部分模块的可行性存疑，暂时没有分解工作。
2、解析现场层别信息，计算全局缺陷召回精度，混淆矩阵，单类召回精度，程度误判率，类型混淆率，现场漏检率等。
3、按程度直接分类，程度的误判降低8%，实际缺陷的召回率提升5%（88.7%，93.5%），但aidi显示的acc会下降7%。
4、已完成。


1、简化缺陷程度划分，测试分类效果。
2、分割缺陷面积判断缺陷程度算法验证。
*2、AVI缺陷信息统计分析，及其与现有缺陷类型的映射。


本次会议对PCB分类算法的结果进行了错例分析和讨论，会议纪要如下：

1、分类实验
    （1）实验目的
        - 拟用分类代替回归分类，验证分类模块在PCB数据集上的效果。
    （2）实验条件
        - 数据集：11初更新label后现场给过来的数据集，从中挑出数据充分的类别（共30类），组成新的数据集9500。
        - 数据集划分：随机3：7划分训练集6657测试集2843，再微调训练集，去掉错误数据。
        - 训练参数：同回归分类。
    （3）实验结论
        - 仍存在部分漏检至OK类别，类间混淆的情况，具体指标见附件。
            - 漏检原因
                - 小缺陷
                - 数据不足，子类模式不充分
                - 部分数据标注出错
            - 类间混淆原因
                - 混淆缺陷特征区分度小

3、会议拟定解决方法
    （1）针对数据不足
        路线1：现场收集数据
        路线2：仿真数据
            - 背景仿真：根据Gerber图 + 首件图，借助人工对齐图像，获取层别列表，得到不同层别的背景图。
            - OK图仿真：从收件图中抠出OK图。
            - 缺陷仿真：提取各种类型缺陷，构建缺陷素材库，用PS等工具将缺陷P到背景上，得到缺陷图。

    （2）针对小缺陷
        路线1：将128*128替换成较小尺寸，如64*64。不足：丢失背景信息，无法区分大小焊盘。
        路线2：获取ROI信息，对ROI之外的区域加mask，mask区域不参与loss计算。不足：过于简单粗暴，背景信息丢失。
        路线3：根据ROI对输入图像或特征图像对应区域加权，ROI对应区域权值最高，权重以某种函数形式向周围递减。

4、现阶段工作
    （1）ROI加权分类算法验证（@谢阳 时间节点：12.11）
        - 选取数据充足的小缺陷，弱缺陷类别，标注ROI。（弱缺陷类别数据可能不足，需要现场收集补充@张辉 时间节点：12.05）
        - 设计实验，验证分析结果。

5、后续工作
    （1）对数据集提需求，确定数据充分性的标准。@谢阳
    （2）提供缺陷ROI信息。@张辉
    （3）现场数据收集，制定高效，快速的数据收集方案。@张辉
    （4）推进数据仿真的相关工作，构建自己的数据库。@刘士清




1、分类实验错例分析与讨论。
2、PCB算法新方案梳理讨论。
3、准备数据  
标注数据，合并标签，划分训练测试集等。
4、修改分类模块。
读取ROI区域，计算权重。

